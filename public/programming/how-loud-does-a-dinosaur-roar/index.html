<!DOCTYPE html>
<script src="d3.min.js" charset="utf-8"></script>

<style>
svg {
  z-index: -1;
}
svg text {
  font-size: 50px;
}
text#volume {
  font-size: 200px;
}

</style>

<title>How loud do dinosaurs roar?</title>

<svg width="1440px" height="900px" viewBox="0 0 1440 900" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <text x="10" y="50">How loud do dinosaurs roar?</text>
        <g id="dinosaur" >
            <g id="head"  transform="translate(-2.000000, 143.000000)">
                <g id="Rectangle-1-+-Oval-1" >
                    <g id="Rectangle-1-+-Oval-1-+-Group-2">
                        <path d="M6.82121026e-13,497.972587 C27.5029434,487.328599 50.0792486,478.562311 56.1665507,484.650056 C87.5332373,516.019026 138.622375,534.0464 138.571909,534.096871 C128.691443,543.978055 128.989772,553.262538 122.090837,567.061414 C115.045954,581.152206 105.761323,517.463031 94.6223844,528.60278 C86.0864018,537.139384 57.5482174,577.021514 83.6350033,583.543685 C138.758487,597.325559 180.422458,537.491834 171.534052,528.60278 C153.851751,510.919192 104.501149,474.770572 116.597146,462.673694 C140.869296,438.399777 223.918321,447.967351 215.483576,490.144147 C214.32221,495.951399 197.818271,462.887448 193.508814,473.661875 C189.371916,484.004873 209.808862,503.924632 199.002504,506.626418 C168.875839,514.158633 169.311744,490.019982 177.027742,528.60278 C205.645748,527.248071 255.971934,527.174034 242.952029,501.132328 C246.188767,441.005982 213.774116,426.107314 177.027742,407.732789 C175.347379,406.892546 212.343951,355.931738 215.483576,352.791884 C239.846976,328.42671 275.304877,314.63792 297.888934,303.34507 C307.411213,301.862348 316.258647,302.12355 324.181884,303.356177 L324.181884,303.356177 L412.163496,212.508689 L443.833601,210.431318 C443.233068,210.286022 442.750887,210.124405 442.393168,209.945532 C428.303401,202.900136 667.000342,191.05878 682.447271,187.969169 C729.228712,195.873003 710.077566,176.900061 731.890485,165.992807 C736.786255,114.284617 735.86272,80.0736212 698.928342,61.6050878 L627.510365,61.6050878 L627.510365,56.1109973 C572.510395,53.7794341 543.696773,27.2600593 495.661793,17.6523638 C450.999975,29.8110821 431.604539,-6.89506809 391.281673,1.17009232 C377.352456,3.95613846 372.449563,22.8825635 363.81322,28.6405448 C323.421806,55.5701149 248.495123,50.567499 188.015123,111.051902 C174.905284,124.162696 160.185732,152.438063 144.065599,160.498717 C113.745952,175.659644 79.9909697,155.467074 56.1665507,149.510536 L12.2170265,149.510536 L12.2170265,144.016445 C7.96228782,145.328807 3.89288624,146.535816 0,147.643632 L2.27373675e-13,497.972587 L6.82121026e-13,497.972587 Z" id="Rectangle-1" fill="#417505"></path>
                        <ellipse id="Oval-1" stroke="#979797" fill="#FFFFFF" transform="translate(416.500000, 50.000000) rotate(-8.000000) translate(-416.500000, -50.000000) " cx="416.5" cy="50" rx="29.5" ry="13"></ellipse>
                        <g id="Group-2" transform="translate(582.000000, 213.000000) rotate(-185.000000) translate(-582.000000, -213.000000) translate(475.000000, 193.000000)" fill="#417505">
                            <polygon id="Triangle-1" points="11 0 22 40 -1.13686838e-13 40 "></polygon>
                            <polygon id="Triangle-2" points="75 0 86 40 64 40 "></polygon>
                            <polygon id="Triangle-3" points="139 -5.68434189e-14 150 40 128 40 "></polygon>
                            <polygon id="Triangle-4" points="203 -5.68434189e-14 214 40 192 40 "></polygon>
                        </g>
                    </g>
                </g>
            </g>
            <g id="lower-jaw" transform="translate(251.000000, 320.000000)" fill="#417505">
              <g id="lower-jaw-rotation" transform="rotate(0 100 40)">
                <g id="lower-bone" transform="translate(222.500000, 81.000000) rotate(1.000000) translate(-222.500000, -81.000000) translate(1.000000, 4.000000)" sketch:type="MSShapeGroup">
                    <path d="M37.2176577,142.736599 C51.7677211,147.753883 60.4088392,154 60.4088392,154 C60.4088392,154 161.642841,136.978713 215.464094,121.13419 C275.595242,112.369912 296.122398,122.23494 351.912719,132.08946 C399.60117,126.118283 384.071381,135.40337 413.934821,126.611825 C452.02077,115.399643 443.911676,64.531089 432.541452,44.4473 C424.45963,30.1719784 183.493256,50.3465649 151.71841,45.1129882 L148.066379,45.3127806 L116.673186,-2.84217094e-14 L20.623266,16.9710994 L0,81.2731345 L28.7734816,134.762452 L37.2176577,142.736599 L37.2176577,142.736599 Z" id="Rectangle-1"></path>
                </g>
                <g id="lower-teeth" transform="translate(199.000000, 9.000000)">
                    <polygon id="Triangle-1" points="11 0 22 40 0 40 "></polygon>
                    <polygon id="Triangle-2" points="75 0 86 40 64 40 "></polygon>
                    <polygon id="Triangle-3" points="139 0 150 40 128 40 "></polygon>
                    <polygon id="Triangle-4" points="203 0 214 40 192 40 "></polygon>
                </g>
                </g>
            </g>
        </g>
  <text x="730" y="500" id='volume'>10</text>
  <text x="730" y="700" id='reset'>reset</text>
</svg>
<script>
function audioNotAllowed() {
  alert("I can't access the microphone. Try Google Chrome");
}
navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
navigator.getUserMedia({audio: true},audioAllowed, audioNotAllowed);

function getAverageVolume(array) {
  var values = 0;
  var average;

  var length = array.length;

  // get all the frequency amplitudes
  for (var i = 0; i < length; i++) {
    values += array[i];
  }

  average = values / length;
  return average;
}

function getMaxVolume(array) {
  var max = 0;

  var length = array.length;

  for(var i = 0; i < length; i++) {
    if(array[i] > max) {
      max = array[i];
    }
  }
  return max;
}

maximum = 0;
var color = d3.scale.linear().domain([0, 100]).range(["green", "red"]);

function displayVolume() {
  array =  new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(array);
  average = getAverageVolume(array);
  //average = getMaxVolume(array);
  score = Math.round((average/255)*100,0);
  d3.selectAll("path, polygon").transition().attr("fill", color(score));
  if(score > maximum) {
    maximum = score;
    d3.select("#volume").transition().text(maximum);
    //d3.selectAll("path, polygon").transition().attr("fill", color(maximum));

  }
  angle = (average/255)*90;
  d3.select("#lower-jaw-rotation").attr("transform", "rotate("+angle+" 100 40)");
}

function audioAllowed(microphone) {
  context = new webkitAudioContext(); // Create audio context
  microphone = context.createMediaStreamSource(microphone);
  analyser = context.createAnalyser(); // Create analyser
  analyser.maxDecibels = 0;
  analyser.fftSize = 512;
  microphone.connect(analyser);
  setInterval(displayVolume,50);
}

d3.select("#reset").on('click', function() { maximum = 0; displayVolume() });
</script>
